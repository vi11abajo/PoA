<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tournament Contract</title>
    <style>
        body {
            font-family: monospace;
            background: #001122;
            color: #00ddff;
            padding: 20px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #00ddff;
            border-radius: 8px;
        }
        button {
            background: #00ddff;
            color: #001122;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .error { color: #ff4444; }
        .success { color: #00ff88; }
        .warning { color: #ffaa00; }
        #log {
            background: #000;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            margin: 10px 0;
            font-size: 12px;
        }
        input {
            background: #001122;
            color: #00ddff;
            border: 1px solid #00ddff;
            padding: 5px;
            width: 400px;
        }
    </style>
</head>
<body>
    <h1>üîç Contract Debug Tool</h1>
    
    <div class="debug-section">
        <h3>Network & Contract Info</h3>
        <div>Network: <span id="network-info">-</span></div>
        <div>Chain ID: <span id="chain-id">-</span></div>
        <div>Account: <span id="account-info">-</span></div>
        <div>Contract: <input id="contract-address" value="0x454064eA4517A80b0388EEeFFFBf2Efb85a86061"></div>
        <button onclick="checkNetwork()">Check Network</button>
    </div>

    <div class="debug-section">
        <h3>Contract Diagnostics</h3>
        <button onclick="checkContractExists()">Check Contract Exists</button>
        <button onclick="checkContractCode()">Get Contract Code</button>
        <button onclick="tryDirectCall()">Try Direct Call</button>
        <button onclick="testWithDirectRPC()">Test via Direct RPC</button>
    </div>

    <div class="debug-section">
        <h3>MetaMask Diagnostics</h3>
        <button onclick="resetMetaMask()">Reset MetaMask State</button>
        <button onclick="switchNetwork()">Force Switch Network</button>
        <button onclick="testPermissions()">Test Permissions</button>
    </div>

    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/web3@4.2.2/dist/web3.min.js"></script>
    <script>
        const CONFIG = {
            NETWORK_NAME: 'Pharos Testnet',
            RPC_URL: 'https://testnet.dplabs-internal.com',
            CHAIN_ID: '688688',
            CHAIN_ID_HEX: '0xa7c5c'
        };

        let web3 = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<span class="${className}">${timestamp}: ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function checkNetwork() {
            try {
                if (!window.ethereum) {
                    log('‚ùå MetaMask not found', 'error');
                    return;
                }

                // Connect to MetaMask
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                web3 = new Web3(window.ethereum);
                
                const chainId = await web3.eth.getChainId();
                const account = accounts[0];
                
                document.getElementById('account-info').textContent = account;
                document.getElementById('chain-id').textContent = chainId + ' (0x' + chainId.toString(16) + ')';
                
                if (chainId.toString() === CONFIG.CHAIN_ID) {
                    document.getElementById('network-info').textContent = CONFIG.NETWORK_NAME + ' ‚úÖ';
                    log('‚úÖ Connected to correct network: ' + CONFIG.NETWORK_NAME, 'success');
                } else {
                    document.getElementById('network-info').textContent = 'Wrong network ‚ùå';
                    log('‚ùå Wrong network. Expected: ' + CONFIG.CHAIN_ID + ', Got: ' + chainId, 'error');
                    log('üí° Switch to Pharos Testnet manually or click "Force Switch Network"', 'warning');
                }
                
            } catch (error) {
                log('‚ùå Network check error: ' + error.message, 'error');
            }
        }

        async function checkContractExists() {
            try {
                const contractAddress = document.getElementById('contract-address').value;
                log('üîç Checking if contract exists at: ' + contractAddress);
                
                if (!web3) {
                    await checkNetwork();
                }
                
                const code = await web3.eth.getCode(contractAddress);
                log('üìÑ Contract code length: ' + code.length);
                
                if (code === '0x' || code === '0x0') {
                    log('‚ùå NO CONTRACT FOUND! Address is empty', 'error');
                    log('üí° This is likely the reason for circuit breaker', 'warning');
                } else {
                    log('‚úÖ Contract exists! Code found.', 'success');
                }
                
            } catch (error) {
                log('‚ùå Contract check error: ' + error.message, 'error');
            }
        }

        async function checkContractCode() {
            try {
                const contractAddress = document.getElementById('contract-address').value;
                
                if (!web3) {
                    await checkNetwork();
                }
                
                const code = await web3.eth.getCode(contractAddress);
                log('üìÑ Full contract code:');
                log(code.substring(0, 200) + '...', 'info');
                
                if (code.length > 10) {
                    log('‚úÖ Contract bytecode looks valid', 'success');
                } else {
                    log('‚ùå Invalid or empty contract', 'error');
                }
                
            } catch (error) {
                log('‚ùå Get code error: ' + error.message, 'error');
            }
        }

        async function tryDirectCall() {
            try {
                const contractAddress = document.getElementById('contract-address').value;
                log('üß™ Attempting direct contract call...');
                
                if (!web3) {
                    await checkNetwork();
                }

                // –ü—Ä–æ—Å—Ç–µ–π—à–∏–π ABI –¥–ª—è tournamentCounter
                const simpleABI = [{
                    "inputs": [],
                    "name": "tournamentCounter",
                    "outputs": [{"name": "", "type": "uint256"}],
                    "stateMutability": "view",
                    "type": "function"
                }];

                const contract = new web3.eth.Contract(simpleABI, contractAddress);
                const result = await contract.methods.tournamentCounter().call();
                
                log('‚úÖ Direct call SUCCESS! Tournament counter: ' + result, 'success');
                
            } catch (error) {
                log('‚ùå Direct call FAILED: ' + error.message, 'error');
                
                if (error.message.includes('circuit breaker')) {
                    log('üö® CIRCUIT BREAKER confirmed active', 'error');
                } else if (error.message.includes('revert')) {
                    log('üí° Contract exists but method failed (normal behavior)', 'warning');
                }
            }
        }

        async function testWithDirectRPC() {
            try {
                log('üîó Testing with direct RPC connection...');
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ RPC
                const directWeb3 = new Web3(CONFIG.RPC_URL);
                const contractAddress = document.getElementById('contract-address').value;
                
                log('üì° Using RPC: ' + CONFIG.RPC_URL);
                
                const code = await directWeb3.eth.getCode(contractAddress);
                log('üìÑ Contract code via direct RPC: ' + (code === '0x' ? 'NOT FOUND' : 'FOUND'));
                
                if (code !== '0x' && code !== '0x0') {
                    // –ü—Ä–æ–±—É–µ–º –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π RPC
                    const simpleABI = [{
                        "inputs": [],
                        "name": "tournamentCounter",
                        "outputs": [{"name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    }];

                    const contract = new directWeb3.eth.Contract(simpleABI, contractAddress);
                    const result = await contract.methods.tournamentCounter().call();
                    
                    log('‚úÖ DIRECT RPC SUCCESS! Counter: ' + result, 'success');
                    log('üí° This confirms contract is working. Issue is with MetaMask', 'warning');
                } else {
                    log('‚ùå Contract not found even via direct RPC', 'error');
                }
                
            } catch (error) {
                log('‚ùå Direct RPC test failed: ' + error.message, 'error');
            }
        }

        async function resetMetaMask() {
            try {
                log('üîÑ Attempting MetaMask reset...');
                
                // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ MetaMask
                if (window.ethereum && window.ethereum.request) {
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–µ—Ç—å —Ç—É–¥–∞-—Å—é–¥–∞
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x1' }] // Ethereum mainnet
                    });
                    
                    setTimeout(async () => {
                        await switchNetwork();
                    }, 1000);
                    
                    log('üí° Switching networks to reset MetaMask state...', 'warning');
                }
                
            } catch (error) {
                log('‚ùå Reset failed: ' + error.message, 'error');
                log('üí° Manual reset: MetaMask Settings -> Advanced -> Reset Account', 'warning');
            }
        }

        async function switchNetwork() {
            try {
                log('üîÑ Switching to Pharos Testnet...');
                
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.CHAIN_ID_HEX }]
                });
                
                log('‚úÖ Network switched successfully', 'success');
                
            } catch (switchError) {
                if (switchError.code === 4902) {
                    log('‚ö†Ô∏è Network not added, adding...', 'warning');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CONFIG.CHAIN_ID_HEX,
                                chainName: CONFIG.NETWORK_NAME,
                                rpcUrls: [CONFIG.RPC_URL],
                                nativeCurrency: { name: 'PHRS', symbol: 'PHRS', decimals: 18 }
                            }]
                        });
                        log('‚úÖ Network added and switched', 'success');
                    } catch (addError) {
                        log('‚ùå Failed to add network: ' + addError.message, 'error');
                    }
                } else {
                    log('‚ùå Switch network failed: ' + switchError.message, 'error');
                }
            }
        }

        async function testPermissions() {
            try {
                log('üîê Testing MetaMask permissions...');
                
                const permissions = await window.ethereum.request({
                    method: 'wallet_getPermissions'
                });
                
                log('üìã Current permissions: ' + JSON.stringify(permissions, null, 2));
                
                // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                log('üë§ Available accounts: ' + accounts.length);
                
            } catch (error) {
                log('‚ùå Permissions test failed: ' + error.message, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('üöÄ Debug tool loaded. Click "Check Network" to start.');
        };
    </script>
</body>
</html>