<!DOCTYPE html>
<html>
<head>
    <title>üöÄ Admin: Start Tournament</title>
    <style>
        body { font-family: monospace; background: #001122; color: #00ddff; padding: 20px; }
        button { background: #00ddff; color: #001122; border: none; padding: 10px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .admin { background: #ff6600; color: white; }
        .success { color: #00ff88; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        input, select { background: #001122; color: #00ddff; border: 1px solid #00ddff; padding: 5px; margin: 5px; }
        #log { background: #000; padding: 15px; height: 300px; overflow-y: auto; border: 1px solid #333; margin: 15px 0; font-size: 12px; }
        .section { border: 1px solid #00ddff; padding: 15px; margin: 15px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üëë Admin Tournament Control</h1>
    
    <div class="section">
        <h3>Connection</h3>
        <button onclick="connectAdmin()">Connect Admin Wallet</button>
        <div id="connection-status">Not connected</div>
    </div>

    <div class="section">
        <h3>Tournament Controls</h3>
        
        <div>
            <label>Tournament ID:</label>
            <input type="number" id="tournament-id" value="1" min="1">
        </div>
        
        <div>
            <label>Entry Fee (PHRS):</label>
            <input type="number" id="entry-fee" value="0.005" step="0.001" min="0">
        </div>
        
        <div>
            <label>Duration (seconds):</label>
            <select id="duration">
                <option value="3600">1 Hour</option>
                <option value="7200">2 Hours</option>
                <option value="21600">6 Hours</option>
                <option value="86400">24 Hours</option>
                <option value="custom">Custom...</option>
            </select>
            <input type="number" id="custom-duration" value="3600" min="60" style="display:none;">
        </div>
        
        <button class="admin" onclick="startTournament()">üöÄ START TOURNAMENT</button>
        <button onclick="checkTournamentStatus()">üìä Check Status</button>
        <button class="admin" onclick="endTournament()">üèÅ END TOURNAMENT</button>
    </div>

    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/web3@4.2.2/dist/web3.min.js"></script>
    <script src="tournament-manager.js"></script>
    <script>
        let connected = false;
        let tournamentManager = new TournamentManager();

        // Duration selector handler
        document.getElementById('duration').onchange = function() {
            const customInput = document.getElementById('custom-duration');
            if (this.value === 'custom') {
                customInput.style.display = 'inline';
            } else {
                customInput.style.display = 'none';
            }
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<span class="${className}">${timestamp}: ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connectAdmin() {
            try {
                log('üëë Connecting admin wallet...');
                
                if (!window.ethereum) {
                    throw new Error('MetaMask not found');
                }

                // Connect MetaMask
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create fake wallet connector object
                const walletConnector = {
                    web3: new Web3(window.ethereum),
                    account: accounts[0],
                    connected: true
                };
                
                // Check network
                const chainId = await walletConnector.web3.eth.getChainId();
                if (chainId !== 688688) {
                    log('‚ö†Ô∏è Wrong network, switching to Pharos Testnet...', 'warning');
                    await switchNetwork();
                }
                
                // Connect tournament manager
                const success = await tournamentManager.connect(walletConnector);
                
                if (success) {
                    connected = true;
                    document.getElementById('connection-status').innerHTML = `‚úÖ Connected: ${accounts[0].substring(0,8)}...`;
                    log(`‚úÖ Admin connected: ${accounts[0]}`, 'success');
                    
                    // Check if really admin
                    const adminAddress = '0x59F74eD82A08F80cff5D7E8055f6a24A18595F64';
                    if (accounts[0].toLowerCase() === adminAddress.toLowerCase()) {
                        log('üëë Admin rights confirmed!', 'success');
                    } else {
                        log(`‚ö†Ô∏è Warning: You are not the configured admin (${adminAddress})`, 'warning');
                    }
                } else {
                    throw new Error('Failed to connect tournament manager');
                }
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xa7c5c' }] // 688688 in hex
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0xa7c5c',
                            chainName: 'Pharos Testnet',
                            rpcUrls: ['https://testnet.dplabs-internal.com'],
                            nativeCurrency: { name: 'PHRS', symbol: 'PHRS', decimals: 18 }
                        }]
                    });
                }
            }
        }

        async function startTournament() {
            try {
                if (!connected) {
                    throw new Error('Connect admin wallet first');
                }

                const tournamentId = parseInt(document.getElementById('tournament-id').value);
                const entryFee = document.getElementById('entry-fee').value;
                const durationSelect = document.getElementById('duration');
                let duration;
                
                if (durationSelect.value === 'custom') {
                    duration = parseInt(document.getElementById('custom-duration').value);
                } else {
                    duration = parseInt(durationSelect.value);
                }

                log(`üöÄ Starting tournament ${tournamentId} with fee ${entryFee} PHRS for ${duration} seconds...`);
                
                const txHash = await tournamentManager.startTournament(tournamentId, entryFee, duration);
                
                log(`‚úÖ TOURNAMENT STARTED! TX: ${txHash}`, 'success');
                log('üéâ Players can now register!', 'success');
                
                // Auto-check status after starting
                setTimeout(() => checkTournamentStatus(), 3000);
                
            } catch (error) {
                log(`‚ùå Start tournament failed: ${error.message}`, 'error');
                
                if (error.message.includes('already started')) {
                    log('üí° Tournament might already be active', 'warning');
                } else if (error.message.includes('Ownable')) {
                    log('üí° Only contract owner can start tournaments', 'warning');
                }
            }
        }

        async function checkTournamentStatus() {
            try {
                if (!connected) {
                    throw new Error('Connect admin wallet first');
                }

                const tournamentId = parseInt(document.getElementById('tournament-id').value);
                log(`üìä Checking tournament ${tournamentId} status...`);
                
                const info = await tournamentManager.getTournamentInfo(tournamentId);
                
                log(`üìã Tournament Info:`, 'success');
                log(`   Entry Fee: ${tournamentManager.web3.utils.fromWei(info.entryFee, 'ether')} PHRS`);
                log(`   Active: ${info.isActive}`);
                log(`   Finished: ${info.isFinished}`);
                log(`   Participants: ${info.participantCount}`);
                log(`   Prize Pool: ${tournamentManager.web3.utils.fromWei(info.prizePool, 'ether')} PHRS`);
                
                const now = Math.floor(Date.now() / 1000);
                const startTime = new Date(info.startTime * 1000);
                const endTime = new Date(info.endTime * 1000);
                
                log(`   Start Time: ${startTime.toLocaleString()}`);
                log(`   End Time: ${endTime.toLocaleString()}`);
                
                if (info.isActive && !info.isFinished) {
                    const remaining = info.endTime - now;
                    const hours = Math.floor(remaining / 3600);
                    const minutes = Math.floor((remaining % 3600) / 60);
                    log(`   ‚è∞ Time remaining: ${hours}h ${minutes}m`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Status check failed: ${error.message}`, 'error');
            }
        }

        async function endTournament() {
            try {
                if (!connected) {
                    throw new Error('Connect admin wallet first');
                }

                const tournamentId = parseInt(document.getElementById('tournament-id').value);
                
                if (!confirm(`Are you sure you want to END tournament ${tournamentId}?`)) {
                    return;
                }

                log(`üèÅ Ending tournament ${tournamentId}...`);
                
                const txHash = await tournamentManager.endTournament(tournamentId);
                
                log(`‚úÖ TOURNAMENT ENDED! TX: ${txHash}`, 'success');
                
            } catch (error) {
                log(`‚ùå End tournament failed: ${error.message}`, 'error');
            }
        }

        // Auto-load
        log('üëë Admin Tournament Control loaded');
        log('üìç Contract: 0x454064eA4517A80b0388EEeFFFBf2Efb85a86061');
        log('üîß Connect your admin wallet and start the tournament');
    </script>
</body>
</html>